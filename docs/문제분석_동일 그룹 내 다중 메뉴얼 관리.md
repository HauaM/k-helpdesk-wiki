# ë¬¸ì œ ë¶„ì„: ë™ì¼ ê·¸ë£¹ ë‚´ ë‹¤ì¤‘ ë©”ë‰´ì–¼ ê´€ë¦¬

**ì‘ì„±ì¼**: 2025-12-15
**ìƒíƒœ**: ë¶„ì„ ì™„ë£Œ, í•´ê²°ë°©ì•ˆ ì œì•ˆ
**ìš°ì„ ìˆœìœ„**: High

---

## 1. ë¬¸ì œ ì •ì˜

### 1.1 í˜„ìƒ

ë™ì¼í•œ `(business_type, error_code)` ê·¸ë£¹ì— **ì „í˜€ ë‹¤ë¥¸ ì›ì¸/ì¡°ì¹˜ì‚¬í•­**ì„ ê°€ì§„ ë©”ë‰´ì–¼ì´ ìƒì„±ë  ë•Œ, ê¸°ì¡´ ë©”ë‰´ì–¼ì´ DEPRECATEDë˜ì–´ **ì •ë³´ ì†ì‹¤**ì´ ë°œìƒí•©ë‹ˆë‹¤.

### 1.2 êµ¬ì²´ì  ì‹œë‚˜ë¦¬ì˜¤

```
ê¸°ì¡´ ë©”ë‰´ì–¼ v1 (APPROVED):
  - business_type: "ê²°ì œ"
  - error_code: "E001"
  - topic: "ì¹´ë“œ ìŠ¹ì¸ ì‹¤íŒ¨ - í•œë„ ì´ˆê³¼"
  - background: "ê³ ê°ì˜ ì¹´ë“œ í•œë„ê°€ ë¶€ì¡±í•˜ì—¬ ê²°ì œê°€ ê±°ë¶€ë¨"
  - guideline: "í•œë„ ì¡°íšŒ í›„ ë‹¤ë¥¸ ì¹´ë“œ ì‚¬ìš© ì•ˆë‚´"

ì‹ ê·œ ì´ˆì•ˆ:
  - business_type: "ê²°ì œ"          # ë™ì¼
  - error_code: "E001"              # ë™ì¼
  - topic: "ì¹´ë“œ ìŠ¹ì¸ ì‹¤íŒ¨ - í†µì‹  ì˜¤ë¥˜"    # ì™„ì „íˆ ë‹¤ë¥¸ ì›ì¸
  - background: "PGì‚¬ì™€ì˜ ë„¤íŠ¸ì›Œí¬ ì¥ì• ë¡œ ìŠ¹ì¸ ìš”ì²­ ì‹¤íŒ¨"
  - guideline: "ì¬ì‹œë„ ë˜ëŠ” ë‹¤ë¥¸ ê²°ì œ ìˆ˜ë‹¨ ì•ˆë‚´"
```

**í˜„ì¬ ì‹œìŠ¤í…œ ë™ì‘:**
1. ComparisonServiceê°€ v1ê³¼ ì‹ ê·œ ì´ˆì•ˆ ë¹„êµ
2. ìœ ì‚¬ë„ ì•½ 30% â†’ `ComparisonType.NEW` íŒì •
3. ë¦¬ë·° íƒœìŠ¤í¬ ìƒì„± â†’ ê²€í† ì ìŠ¹ì¸
4. **v1ì´ DEPRECATEDë¡œ ë³€ê²½**, ì‹ ê·œê°€ v2ë¡œ APPROVED
5. **ê²°ê³¼**: "í•œë„ ì´ˆê³¼" ì¼€ì´ìŠ¤ ì •ë³´ê°€ ê²€ìƒ‰ ë¶ˆê°€ëŠ¥í•´ì§

### 1.3 ê·¼ë³¸ ì›ì¸

**ì„¤ê³„ ê°€ì •ì˜ í•œê³„:**
- í˜„ì¬ ì‹œìŠ¤í…œì€ `(business_type, error_code)` ê·¸ë£¹ë‹¹ **1ê°œì˜ ìµœì‹  APPROVED ë©”ë‰´ì–¼ë§Œ** í™œì„± ìƒíƒœë¡œ ìœ ì§€
- ë²„ì „ ì—…ê·¸ë ˆì´ë“œ ì‹œ ì´ì „ ë²„ì „ì€ ë¬´ì¡°ê±´ DEPRECATED ì²˜ë¦¬
- ê°™ì€ ì—ëŸ¬ì½”ë“œì— **ì—¬ëŸ¬ ì›ì¸/ì¼€ì´ìŠ¤**ê°€ ìˆì„ ìˆ˜ ìˆë‹¤ëŠ” ì ì„ ê³ ë ¤í•˜ì§€ ì•ŠìŒ

**ì½”ë“œ ìœ„ì¹˜:**
- [app/services/manual_service.py:1157-1171](app/services/manual_service.py#L1157-L1171) `_deprecate_previous_entries`
- [app/services/comparison_service.py:163-204](app/services/comparison_service.py#L163-204) `_get_target_manual` - ìµœì‹  1ê°œë§Œ ì¡°íšŒ

```python
# í˜„ì¬ ë¡œì§: ë¬´ì¡°ê±´ ì´ì „ APPROVEDë¥¼ DEPRECATED ì²˜ë¦¬
async def _deprecate_previous_entries(self, manual: ManualEntry) -> None:
    """ë™ì¼ í‚¤(ì—…ë¬´êµ¬ë¶„/ì—ëŸ¬ì½”ë“œ)ë¥¼ ê°€ì§„ ê¸°ì¡´ ìŠ¹ì¸ ë©”ë‰´ì–¼ì„ DEPRECATED ì²˜ë¦¬."""

    stmt = select(ManualEntry).where(
        ManualEntry.business_type == manual.business_type,
        ManualEntry.error_code == manual.error_code,
        ManualEntry.status == ManualStatus.APPROVED,
        ManualEntry.id != manual.id,
    )

    to_deprecate = (await self.session.execute(stmt)).scalars().all()

    for entry in to_deprecate:
        entry.status = ManualStatus.DEPRECATED  # â† ì •ë³´ ì†ì‹¤ ì§€ì 
```

---

## 2. ì˜í–¥ ë¶„ì„

### 2.1 ë¹„ì¦ˆë‹ˆìŠ¤ ì˜í–¥

| ì˜í–¥ ì˜ì—­ | ì‹¬ê°ë„ | ì„¤ëª… |
|---------|--------|------|
| **ì •ë³´ ì†ì‹¤** | ğŸ”´ Critical | ê°™ì€ ì—ëŸ¬ì½”ë“œì˜ ë‹¤ì–‘í•œ ì›ì¸ë³„ ëŒ€ì‘ ë°©ë²•ì´ ì‚¬ë¼ì§ |
| **ê²€ìƒ‰ í’ˆì§ˆ ì €í•˜** | ğŸ”´ Critical | ìƒë‹´ì‚¬ê°€ ê³¼ê±° ì¼€ì´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ |
| **ë°˜ë³µ ì‘ì—…** | ğŸŸ¡ Medium | ê°™ì€ ë‚´ìš©ì„ ë°˜ë³µ ìƒì„±í•´ì•¼ í•¨ |
| **ë„ë©”ì¸ ì§€ì‹ ê´€ë¦¬** | ğŸ”´ Critical | ì¡°ì§ì˜ ì¶•ì ëœ ë…¸í•˜ìš°ê°€ ìœ ì‹¤ë¨ |

### 2.2 ê¸°ìˆ  ë¶€ì±„

- í˜„ì¬ `ManualVersion` ëª¨ë¸ì€ ê·¸ë£¹ë‹¹ ì„ í˜•ì  ë²„ì „ ê´€ë¦¬ë§Œ ì§€ì› (v1 â†’ v2 â†’ v3)
- ë¶„ê¸°(branch) ê°œë… ì—†ìŒ: ê°™ì€ v1ì—ì„œ v2-A, v2-Bë¡œ ê°ˆë¼ì§€ëŠ” êµ¬ì¡° ë¶ˆê°€ëŠ¥
- ë²¡í„° ê²€ìƒ‰ ì¸ë±ìŠ¤ëŠ” APPROVEDë§Œ í¬í•¨í•˜ë¯€ë¡œ DEPRECATED ë‚´ìš©ì€ ê²€ìƒ‰ ë¶ˆê°€

---

## 3. í•´ê²°ë°©ì•ˆ ì œì•ˆ

### ë°©ì•ˆ 1: ë‹¤ì¤‘ í™œì„± ë©”ë‰´ì–¼ ì§€ì› (ì¶”ì²œ) â­

#### ê°œìš”
ê°™ì€ `(business_type, error_code)` ê·¸ë£¹ì— **ì—¬ëŸ¬ ê°œì˜ APPROVED ë©”ë‰´ì–¼**ì„ ë™ì‹œì— ìœ ì§€í•  ìˆ˜ ìˆë„ë¡ ë³€ê²½í•©ë‹ˆë‹¤.

#### DB ìŠ¤í‚¤ë§ˆ ë³€ê²½

```sql
-- manual_entries í…Œì´ë¸”ì— ì„¸ë¶€ ë¶„ë¥˜ ì¶”ê°€
ALTER TABLE manual_entries
ADD COLUMN sub_category VARCHAR(100) NULL
COMMENT 'ì„¸ë¶€ ë¶„ë¥˜ (ì˜ˆ: í•œë„ì´ˆê³¼, í†µì‹ ì˜¤ë¥˜, ì¹´ë“œì •ì§€ ë“±)';

-- ê°™ì€ ê·¸ë£¹ ë‚´ì—ì„œ sub_categoryë³„ë¡œ 1ê°œì˜ APPROVEDë§Œ í—ˆìš©
CREATE UNIQUE INDEX idx_manual_unique_subcategory
ON manual_entries(business_type, error_code, sub_category, status)
WHERE status = 'APPROVED';
```

#### ë°ì´í„° ëª¨ë¸ ë³€ê²½

```python
# app/models/manual.py
class ManualEntry(BaseModel):
    __tablename__ = "manual_entries"

    # ê¸°ì¡´ í•„ë“œë“¤...
    business_type: Mapped[str | None] = mapped_column(String(50), index=True)
    error_code: Mapped[str | None] = mapped_column(String(50), index=True)

    # ìƒˆë¡œìš´ í•„ë“œ
    sub_category: Mapped[str | None] = mapped_column(
        String(100),
        nullable=True,
        index=True,
        comment="ì„¸ë¶€ ë¶„ë¥˜ (í•œë„ì´ˆê³¼, í†µì‹ ì˜¤ë¥˜ ë“±)",
    )
```

#### ë¹„êµ ë¡œì§ ë³€ê²½

```python
# app/services/comparison_service.py
async def _get_target_manual(
    self, new_draft: ManualEntry, compare_with_manual_id: UUID | None
) -> Optional[ManualEntry]:
    """
    ë³€ê²½ ì‚¬í•­:
    1. topic ìœ ì‚¬ë„ë¥¼ ë¨¼ì € ê³„ì‚°
    2. topicì´ ìœ ì‚¬í•œ ë©”ë‰´ì–¼ë§Œ ì „ì²´ ë¹„êµ
    3. topicì´ ë‹¤ë¥´ë©´ ë³„ë„ ë©”ë‰´ì–¼ë¡œ ì²˜ë¦¬ (sub_category ìë™ í• ë‹¹)
    """

    if compare_with_manual_id is not None:
        return await self.manual_repo.get_by_id(compare_with_manual_id)

    # ê°™ì€ ê·¸ë£¹ì˜ ëª¨ë“  APPROVED ë©”ë‰´ì–¼ ì¡°íšŒ
    candidates = await self.manual_repo.find_all_approved_by_group(
        business_type=new_draft.business_type,
        error_code=new_draft.error_code,
    )

    # ê° í›„ë³´ì™€ topic ìœ ì‚¬ë„ ê³„ì‚°
    best_match = None
    best_topic_similarity = 0.0

    for candidate in candidates:
        topic_similarity = await self.vectorstore.similarity(
            text1=new_draft.topic,
            text2=candidate.topic,
        )

        if topic_similarity > best_topic_similarity:
            best_topic_similarity = topic_similarity
            best_match = candidate

    # topic ìœ ì‚¬ë„ê°€ 70% ì´ìƒì¸ ê²½ìš°ë§Œ ê°™ì€ ë©”ë‰´ì–¼ë¡œ íŒë‹¨
    if best_topic_similarity >= 0.7:
        return best_match
    else:
        # topicì´ ë‹¤ë¥´ë©´ ë³„ë„ ë©”ë‰´ì–¼ (sub_category ë‹¤ë¥´ê²Œ ì„¤ì •)
        return None
```

#### DEPRECATED ë¡œì§ ë³€ê²½

```python
# app/services/manual_service.py
async def _deprecate_previous_entries(self, manual: ManualEntry) -> None:
    """
    ë³€ê²½ ì‚¬í•­: sub_categoryê°€ ê°™ì€ ë©”ë‰´ì–¼ë§Œ DEPRECATED ì²˜ë¦¬
    """

    stmt = select(ManualEntry).where(
        ManualEntry.business_type == manual.business_type,
        ManualEntry.error_code == manual.error_code,
        ManualEntry.sub_category == manual.sub_category,  # â† ì¶”ê°€
        ManualEntry.status == ManualStatus.APPROVED,
        ManualEntry.id != manual.id,
    )

    to_deprecate = (await self.session.execute(stmt)).scalars().all()

    for entry in to_deprecate:
        entry.status = ManualStatus.DEPRECATED

    if to_deprecate:
        await self.session.flush()
```

#### ë²„ì „ ê´€ë¦¬ ë³€ê²½

```python
# app/models/manual.py
class ManualVersion(BaseModel):
    """
    ë³€ê²½ ì‚¬í•­: sub_category ì¶”ê°€ë¡œ ë²„ì „ ë¼ì¸ ë¶„ë¦¬
    """
    __tablename__ = "manual_versions"

    business_type: Mapped[str | None] = mapped_column(String(50), index=True)
    error_code: Mapped[str | None] = mapped_column(String(50), index=True)
    sub_category: Mapped[str | None] = mapped_column(String(100), index=True)  # ì¶”ê°€
    version: Mapped[str] = mapped_column(String(50), nullable=False)

    __table_args__ = (
        UniqueConstraint(
            "business_type",
            "error_code",
            "sub_category",  # â† ì¶”ê°€
            "version",
            name="uq_manual_version_group_subcategory",
        ),
    )
```

#### ì¥ì 
- âœ… ê°™ì€ ì—ëŸ¬ì½”ë“œì˜ **ë‹¤ì–‘í•œ ì›ì¸ë³„ ë©”ë‰´ì–¼** ë™ì‹œ ìœ ì§€
- âœ… ì •ë³´ ì†ì‹¤ ì—†ìŒ
- âœ… ê²€ìƒ‰ ì‹œ **ëª¨ë“  ê´€ë ¨ ì¼€ì´ìŠ¤** ë°˜í™˜ ê°€ëŠ¥
- âœ… ëª…í™•í•œ ë¶„ë¥˜ ì²´ê³„

#### ë‹¨ì 
- âŒ DB ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”
- âŒ ê¸°ì¡´ ì½”ë“œ ì—¬ëŸ¬ ê³³ ìˆ˜ì • í•„ìš”
- âŒ sub_category ìë™ ìƒì„± ë¡œì§ í•„ìš”

#### êµ¬í˜„ ìš°ì„ ìˆœìœ„
1. **P0**: DB ìŠ¤í‚¤ë§ˆ ë§ˆì´ê·¸ë ˆì´ì…˜
2. **P0**: ComparisonService ë¡œì§ ë³€ê²½
3. **P1**: ManualService DEPRECATED ë¡œì§ ë³€ê²½
4. **P1**: ê²€ìƒ‰/ì¡°íšŒ API ë³€ê²½
5. **P2**: UI/UX ê°œì„  (ê·¸ë£¹ ë‚´ ì—¬ëŸ¬ ë©”ë‰´ì–¼ í‘œì‹œ)

---

### ë°©ì•ˆ 2: ê³„ì¸µì  í† í”½ êµ¬ì¡° (ì¤‘ê°„ì•ˆ)

#### ê°œìš”
DB ìŠ¤í‚¤ë§ˆ ë³€ê²½ ì—†ì´ **topic ê¸°ë°˜ ê·¸ë£¹í•‘**ìœ¼ë¡œ í•´ê²°í•©ë‹ˆë‹¤.

#### êµ¬í˜„ ë°©ì‹

```python
# app/services/comparison_service.py
async def compare(
    self,
    new_draft: ManualEntry,
    compare_with_manual_id: UUID | None = None,
    *,
    topic_similarity_threshold: float = 0.7,  # ì¶”ê°€
    similarity_threshold_similar: float = 0.95,
    similarity_threshold_supplement: float = 0.7,
) -> ComparisonResult:
    """
    ë³€ê²½ ì‚¬í•­: topic ìœ ì‚¬ë„ë¥¼ ë¨¼ì € ê²€ì‚¬í•˜ì—¬ ë‹¤ë¥¸ ì¼€ì´ìŠ¤ íŒë³„
    """

    target_manual = await self._get_target_manual(new_draft, compare_with_manual_id)

    if target_manual is None:
        return ComparisonResult(
            comparison_type=ComparisonType.NEW,
            reason="no_existing_manual_found",
        )

    # Step 1: topic ìœ ì‚¬ë„ ë¨¼ì € ê³„ì‚°
    topic_similarity = await self.vectorstore.similarity(
        text1=new_draft.topic,
        text2=target_manual.topic,
    )

    # topicì´ ë‹¤ë¥´ë©´ ë³„ë„ ì¼€ì´ìŠ¤ë¡œ ì²˜ë¦¬
    if topic_similarity < topic_similarity_threshold:
        logger.info(
            "comparison_different_topic",
            new_topic=new_draft.topic,
            existing_topic=target_manual.topic,
            topic_similarity=topic_similarity,
        )
        return ComparisonResult(
            comparison_type=ComparisonType.NEW,
            reason=f"different_topic_similarity_{topic_similarity:.2f}",
        )

    # Step 2: topicì´ ìœ ì‚¬í•˜ë©´ ì „ì²´ ë‚´ìš© ë¹„êµ (ê¸°ì¡´ ë¡œì§)
    new_draft_text = self._build_manual_text(new_draft)
    target_manual_text = self._build_manual_text(target_manual)

    similarity_score = await self.vectorstore.similarity(
        text1=new_draft_text,
        text2=target_manual_text,
    )

    # ... (ê¸°ì¡´ ìœ ì‚¬ë„ íŒì • ë¡œì§)
```

#### DEPRECATED ë¡œì§ ê°œì„ 

```python
# app/services/manual_service.py
async def _deprecate_previous_entries(self, manual: ManualEntry) -> None:
    """
    ë³€ê²½ ì‚¬í•­: topicì´ ìœ ì‚¬í•œ ë©”ë‰´ì–¼ë§Œ DEPRECATED ì²˜ë¦¬
    """

    # ê°™ì€ ê·¸ë£¹ì˜ ëª¨ë“  APPROVED ë©”ë‰´ì–¼ ì¡°íšŒ
    stmt = select(ManualEntry).where(
        ManualEntry.business_type == manual.business_type,
        ManualEntry.error_code == manual.error_code,
        ManualEntry.status == ManualStatus.APPROVED,
        ManualEntry.id != manual.id,
    )

    candidates = (await self.session.execute(stmt)).scalars().all()

    # topic ìœ ì‚¬ë„ê°€ ë†’ì€ ê²ƒë§Œ DEPRECATED
    to_deprecate = []
    for candidate in candidates:
        topic_similarity = await self.vectorstore.similarity(
            text1=manual.topic,
            text2=candidate.topic,
        )

        if topic_similarity >= 0.7:  # topicì´ ìœ ì‚¬í•œ ê²½ìš°ë§Œ
            to_deprecate.append(candidate)

    for entry in to_deprecate:
        entry.status = ManualStatus.DEPRECATED

    if to_deprecate:
        await self.session.flush()
```

#### ì¥ì 
- âœ… DB ìŠ¤í‚¤ë§ˆ ë³€ê²½ ì—†ìŒ
- âœ… ë…¼ë¦¬ì ìœ¼ë¡œ ë‹¤ë¥¸ ì¼€ì´ìŠ¤ëŠ” ë³„ë„ ê´€ë¦¬
- âœ… ë¹ ë¥¸ ì ìš© ê°€ëŠ¥

#### ë‹¨ì 
- âš ï¸ topic ìœ ì‚¬ë„ ì„ê³„ê°’ ì¡°ì • í•„ìš”
- âš ï¸ ë²„ì „ ë²ˆí˜¸ í˜¼ë€ (v1, v2ê°€ ì™„ì „íˆ ë‹¤ë¥¸ ë‚´ìš©)
- âš ï¸ ëª…ì‹œì  ë¶„ë¥˜ ì²´ê³„ ë¶€ì¬

---

### ë°©ì•ˆ 3: ë¦¬ë·° ì›Œí¬í”Œë¡œìš° ê°œì„  (ìµœì†Œ ë³€ê²½)

#### ê°œìš”
ì‹œìŠ¤í…œ ë¡œì§ì€ ìœ ì§€í•˜ë˜, **ë¦¬ë·° íƒœìŠ¤í¬ì—ì„œ ê²€í† ìê°€ íŒë‹¨**í•˜ë„ë¡ í•©ë‹ˆë‹¤.

#### ManualReviewTask ë©”íƒ€ë°ì´í„° í™•ì¥

```python
# app/schemas/task.py
class ManualReviewTaskCreate(BaseModel):
    # ê¸°ì¡´ í•„ë“œë“¤...

    # ì¶”ê°€: ë¹„êµ ì„¸ë¶€ ì •ë³´
    comparison_metadata: dict | None = None
    """
    {
        "existing_topic": "ì¹´ë“œ ìŠ¹ì¸ ì‹¤íŒ¨ - í•œë„ ì´ˆê³¼",
        "new_topic": "ì¹´ë“œ ìŠ¹ì¸ ì‹¤íŒ¨ - í†µì‹  ì˜¤ë¥˜",
        "topic_similarity": 0.65,
        "content_similarity": 0.30,
        "suggestion": "SEPARATE_MANUAL",  # or "MERGE_CONTENT"
        "conflict_reason": "completely_different_cause"
    }
    """
```

#### ë¦¬ë·° íƒœìŠ¤í¬ ìƒì„± ì‹œ ë©”íƒ€ë°ì´í„° ì¶”ê°€

```python
# app/services/manual_service.py
async def _create_review_task(
    self,
    new_entry: ManualEntry,
    old_entry: ManualEntry | None,
    comparison_type: ComparisonType,
    similarity_score: float | None,
    reason: str,
    auto_merged: bool = False,
) -> ManualReviewTask:
    """ë³€ê²½ ì‚¬í•­: comparison_metadata ì¶”ê°€"""

    # topic ìœ ì‚¬ë„ ê³„ì‚°
    topic_similarity = None
    if old_entry and self.vectorstore:
        topic_similarity = await self.vectorstore.similarity(
            text1=new_entry.topic,
            text2=old_entry.topic,
        )

    # ë©”íƒ€ë°ì´í„° êµ¬ì„±
    comparison_metadata = {
        "existing_topic": old_entry.topic if old_entry else None,
        "new_topic": new_entry.topic,
        "topic_similarity": topic_similarity,
        "content_similarity": similarity_score,
        "comparison_type": comparison_type.value,
        "auto_merged": auto_merged,
    }

    # ì¶”ì²œ ì•¡ì…˜ ê²°ì •
    if topic_similarity and topic_similarity < 0.6:
        comparison_metadata["suggestion"] = "SEPARATE_MANUAL"
        comparison_metadata["conflict_reason"] = "different_topic_detected"
    elif similarity_score and similarity_score >= 0.7:
        comparison_metadata["suggestion"] = "MERGE_CONTENT"
        comparison_metadata["conflict_reason"] = "similar_content"
    else:
        comparison_metadata["suggestion"] = "NEW_VERSION"

    # íƒœìŠ¤í¬ ìƒì„±
    task = ManualReviewTask(
        new_entry_id=new_entry.id,
        old_entry_id=old_entry.id if old_entry else None,
        comparison_metadata=comparison_metadata,  # ì¶”ê°€
        # ... ê¸°ì¡´ í•„ë“œë“¤
    )

    return await self.review_repo.create(task)
```

#### ë¦¬ë·° ìŠ¹ì¸ ì‹œ ì˜µì…˜ ì œê³µ

```python
# app/schemas/task.py
class ManualReviewApproveRequest(BaseModel):
    approver_id: UUID

    # ì¶”ê°€: ê²€í† ìì˜ ê²°ì •
    action: Literal["REPLACE", "MERGE", "SEPARATE"] = "REPLACE"
    """
    - REPLACE: ê¸°ì¡´ ë©”ë‰´ì–¼ì„ DEPRECATEDí•˜ê³  ìƒˆ ë©”ë‰´ì–¼ì„ APPROVED (ê¸°ë³¸)
    - MERGE: ê¸°ì¡´ ë©”ë‰´ì–¼ì— ë‚´ìš© ë³‘í•© (new_entryëŠ” ARCHIVED)
    - SEPARATE: ë³„ë„ ë©”ë‰´ì–¼ë¡œ ë¶„ë¦¬ (error_code ì„¸ë¶„í™” ìš”ì²­)
    """

    new_error_code: str | None = None  # SEPARATE ì„ íƒ ì‹œ í•„ìˆ˜
```

#### ìŠ¹ì¸ ë¡œì§ ë¶„ê¸°

```python
# app/services/task_service.py
async def approve_review_task(
    self, task_id: UUID, request: ManualReviewApproveRequest
) -> ManualReviewTask:
    """ë³€ê²½ ì‚¬í•­: actionì— ë”°ë¥¸ ë¶„ê¸° ì²˜ë¦¬"""

    task = await self.review_repo.get_by_id(task_id)
    # ... ê²€ì¦ ë¡œì§

    if request.action == "REPLACE":
        # ê¸°ì¡´ ë¡œì§: DEPRECATED ì²˜ë¦¬ í›„ ìŠ¹ì¸
        await self._approve_and_deprecate_old(task)

    elif request.action == "MERGE":
        # ê¸°ì¡´ ë©”ë‰´ì–¼ì— ë³‘í•©, new_entryëŠ” ARCHIVED
        await self._merge_into_existing(task)

    elif request.action == "SEPARATE":
        # error_code ë³€ê²½ í›„ ë³„ë„ ë©”ë‰´ì–¼ë¡œ ìŠ¹ì¸
        if not request.new_error_code:
            raise ValidationError("new_error_code required for SEPARATE action")
        await self._approve_as_separate(task, request.new_error_code)

    task.status = TaskStatus.APPROVED
    task.resolved_at = datetime.utcnow()

    return await self.review_repo.update(task)
```

#### ì¥ì 
- âœ… ì‹œìŠ¤í…œ ë³€ê²½ ìµœì†Œí™”
- âœ… **ë„ë©”ì¸ ì „ë¬¸ê°€ì˜ íŒë‹¨** í™œìš©
- âœ… ìœ ì—°í•œ ëŒ€ì‘ ê°€ëŠ¥
- âœ… ë¹ ë¥¸ êµ¬í˜„ ê°€ëŠ¥

#### ë‹¨ì 
- âŒ ë§¤ë²ˆ ìˆ˜ë™ íŒë‹¨ í•„ìš”
- âŒ ìë™í™” ì •ë„ ë‚®ìŒ
- âŒ ì¼ê´€ì„± ìœ ì§€ ì–´ë ¤ì›€

---

## 4. ê¶Œì¥ ì ‘ê·¼ ë°©ì‹ (í•˜ì´ë¸Œë¦¬ë“œ)

### Phase 1: ì¦‰ì‹œ ì ìš© (ë°©ì•ˆ 3)

**ëª©í‘œ**: ê²€í† ìì—ê²Œ ì¶©ë¶„í•œ ì •ë³´ ì œê³µ

1. âœ… `ManualReviewTask`ì— `comparison_metadata` ì¶”ê°€
2. âœ… topic ìœ ì‚¬ë„ ê³„ì‚° ë° ì œê³µ
3. âœ… ë¦¬ë·° UIì—ì„œ "REPLACE / MERGE / SEPARATE" ì„ íƒ ê°€ëŠ¥
4. âœ… ë¡œê¹… ë° ëª¨ë‹ˆí„°ë§ ê°•í™”

**ì˜ˆìƒ ì†Œìš” ì‹œê°„**: 1-2 ì£¼

### Phase 2: ì¥ê¸° ê°œì„  (ë°©ì•ˆ 1)

**ëª©í‘œ**: ì‹œìŠ¤í…œ ì°¨ì›ì—ì„œ ë‹¤ì¤‘ ë©”ë‰´ì–¼ ì§€ì›

1. ğŸ”„ DB ìŠ¤í‚¤ë§ˆì— `sub_category` ì¶”ê°€
2. ğŸ”„ ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
3. ğŸ”„ ComparisonService ë¡œì§ ë³€ê²½
4. ğŸ”„ DEPRECATED ë¡œì§ ê°œì„ 
5. ğŸ”„ ê²€ìƒ‰/ì¡°íšŒ API ìˆ˜ì •
6. ğŸ”„ UIì—ì„œ sub_categoryë³„ ê·¸ë£¹í•‘ í‘œì‹œ

**ì˜ˆìƒ ì†Œìš” ì‹œê°„**: 3-4 ì£¼

---

## 5. ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ ê°œì„ ì•ˆ

### 5.1 ê²€ìƒ‰ ê²°ê³¼ í™”ë©´ (Phase 2 ì™„ë£Œ í›„)

```
ğŸ” ê²€ìƒ‰ì–´: "ê²°ì œ ì˜¤ë¥˜ E001"

ğŸ“Œ ê²°ì œ > E001 (3ê±´ì˜ í™œì„± ë©”ë‰´ì–¼)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… v1.3 - í•œë„ ì´ˆê³¼ (í˜„ì¬ ë²„ì „)          [2024-12-10]  â”‚
â”‚  ë°°ê²½: ê³ ê°ì˜ ì¹´ë“œ í•œë„ê°€ ë¶€ì¡±í•˜ì—¬ ê²°ì œê°€ ê±°ë¶€ë¨         â”‚
â”‚  ì¡°ì¹˜: í•œë„ ì¡°íšŒ í›„ ë‹¤ë¥¸ ì¹´ë“œ ì‚¬ìš© ì•ˆë‚´                 â”‚
â”‚  [ìƒì„¸ë³´ê¸°] [ìˆ˜ì •]                    ì¡°íšŒìˆ˜: 45íšŒ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… v1.2 - í†µì‹  ì˜¤ë¥˜                      [2024-12-08]  â”‚
â”‚  ë°°ê²½: PGì‚¬ì™€ì˜ ë„¤íŠ¸ì›Œí¬ ì¥ì• ë¡œ ìŠ¹ì¸ ìš”ì²­ ì‹¤íŒ¨          â”‚
â”‚  ì¡°ì¹˜: ì¬ì‹œë„ ë˜ëŠ” ë‹¤ë¥¸ ê²°ì œ ìˆ˜ë‹¨ ì•ˆë‚´                  â”‚
â”‚  [ìƒì„¸ë³´ê¸°] [ìˆ˜ì •]                    ì¡°íšŒìˆ˜: 23íšŒ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… v1.1 - ì¹´ë“œ ì •ì§€                      [2024-12-05]  â”‚
â”‚  ë°°ê²½: ë„ë‚œ/ë¶„ì‹¤ ì‹ ê³ ëœ ì¹´ë“œë¡œ ê²°ì œ ì‹œë„                â”‚
â”‚  ì¡°ì¹˜: ì¹´ë“œì‚¬ í™•ì¸ í›„ ì¬ë°œê¸‰ ì•ˆë‚´                       â”‚
â”‚  [ìƒì„¸ë³´ê¸°] [ìˆ˜ì •]                    ì¡°íšŒìˆ˜: 12íšŒ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[ì´ì „ ë²„ì „ ë³´ê¸° (5ê±´)] [ë³´ê´€ëœ ë©”ë‰´ì–¼ (2ê±´)]
```

### 5.2 ë¦¬ë·° íƒœìŠ¤í¬ í™”ë©´ (Phase 1)

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ ë©”ë‰´ì–¼ ê²€í†  ìš”ì²­ #1234
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš ï¸ ì¶©ëŒ ê°ì§€: ê°™ì€ ì—ëŸ¬ì½”ë“œ(E001)ì´ì§€ë§Œ ì›ì¸ì´ ë‹¤ë¦…ë‹ˆë‹¤

â”Œâ”€ ê¸°ì¡´ ë©”ë‰´ì–¼ (v1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì£¼ì œ: ì¹´ë“œ ìŠ¹ì¸ ì‹¤íŒ¨ - í•œë„ ì´ˆê³¼                        â”‚
â”‚ ë°°ê²½: ê³ ê°ì˜ ì¹´ë“œ í•œë„ê°€ ë¶€ì¡±í•˜ì—¬...                    â”‚
â”‚ ì¡°ì¹˜: í•œë„ ì¡°íšŒ í›„ ë‹¤ë¥¸ ì¹´ë“œ ì‚¬ìš©...                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ ì‹ ê·œ ì´ˆì•ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì£¼ì œ: ì¹´ë“œ ìŠ¹ì¸ ì‹¤íŒ¨ - í†µì‹  ì˜¤ë¥˜                        â”‚
â”‚ ë°°ê²½: PGì‚¬ì™€ì˜ ë„¤íŠ¸ì›Œí¬ ì¥ì• ë¡œ...                       â”‚
â”‚ ì¡°ì¹˜: ì¬ì‹œë„ ë˜ëŠ” ë‹¤ë¥¸ ê²°ì œ ìˆ˜ë‹¨...                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“Š ìœ ì‚¬ë„ ë¶„ì„:
  - ì£¼ì œ ìœ ì‚¬ë„: 65% (ë‹¤ë¥¸ ì¼€ì´ìŠ¤ë¡œ íŒë‹¨ë¨)
  - ë‚´ìš© ìœ ì‚¬ë„: 30% (ì „í˜€ ë‹¤ë¥¸ ë‚´ìš©)

ğŸ’¡ ì‹œìŠ¤í…œ ê¶Œì¥: SEPARATE_MANUAL (ë³„ë„ ë©”ë‰´ì–¼ë¡œ ë¶„ë¦¬)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ì²˜ë¦¬ ë°©ë²•ì„ ì„ íƒí•˜ì„¸ìš”:

â—¯ ê¸°ì¡´ ë©”ë‰´ì–¼ êµì²´ (REPLACE)
   â†’ v1ì€ DEPRECATED, ì‹ ê·œê°€ v2ë¡œ ìŠ¹ì¸
   âš ï¸ "í•œë„ ì´ˆê³¼" ì •ë³´ê°€ ê²€ìƒ‰ ë¶ˆê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤

â—¯ ê¸°ì¡´ ë©”ë‰´ì–¼ì— ë³‘í•© (MERGE)
   â†’ v1ì— í†µì‹  ì˜¤ë¥˜ ì¼€ì´ìŠ¤ ì¶”ê°€, ì‹ ê·œ ì´ˆì•ˆì€ ë³´ê´€
   âš ï¸ í•˜ë‚˜ì˜ ë©”ë‰´ì–¼ì— ì—¬ëŸ¬ ì›ì¸ì´ ì„ì…ë‹ˆë‹¤

â—‰ ë³„ë„ ë©”ë‰´ì–¼ë¡œ ë¶„ë¦¬ (SEPARATE) â­ ê¶Œì¥
   â†’ ì—ëŸ¬ì½”ë“œë¥¼ ì„¸ë¶„í™”í•˜ì—¬ ë³„ë„ ë©”ë‰´ì–¼ ìƒì„±
   â†’ ìƒˆ ì—ëŸ¬ì½”ë“œ: E001-NETWORK
   âœ… ë‘ ì¼€ì´ìŠ¤ ëª¨ë‘ í™œì„± ìƒíƒœë¡œ ìœ ì§€ë©ë‹ˆë‹¤

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ìƒˆ ì—ëŸ¬ì½”ë“œ: [E001-NETWORK        ]

[ìŠ¹ì¸] [ë°˜ë ¤] [ë‚˜ì¤‘ì— ê²€í† ]
```

### 5.3 ë²„ì „ íˆìŠ¤í† ë¦¬ í™”ë©´

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“š ë©”ë‰´ì–¼ ê·¸ë£¹: ê²°ì œ > E001
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

[íƒ­] í™œì„± ë©”ë‰´ì–¼ (3) | ì´ì „ ë²„ì „ (5) | ë³´ê´€ë¨ (2)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
í™œì„± ë©”ë‰´ì–¼ (Active Manuals)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â”Œâ”€ í•œë„ ì´ˆê³¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“— v1.3 (2024-12-10 ìŠ¹ì¸)                              â”‚
â”‚    â”œâ”€ ì¡°íšŒìˆ˜: 45íšŒ                                      â”‚
â”‚    â”œâ”€ ìµœê·¼ ìƒë‹´: 5ê±´                                    â”‚
â”‚    â””â”€ [ìƒì„¸ë³´ê¸°] [ìˆ˜ì •] [ë²„ì „ íˆìŠ¤í† ë¦¬]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ í†µì‹  ì˜¤ë¥˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“˜ v1.2 (2024-12-08 ìŠ¹ì¸)                              â”‚
â”‚    â”œâ”€ ì¡°íšŒìˆ˜: 23íšŒ                                      â”‚
â”‚    â”œâ”€ ìµœê·¼ ìƒë‹´: 3ê±´                                    â”‚
â”‚    â””â”€ [ìƒì„¸ë³´ê¸°] [ìˆ˜ì •] [ë²„ì „ íˆìŠ¤í† ë¦¬]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ ì¹´ë“œ ì •ì§€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“™ v1.1 (2024-12-05 ìŠ¹ì¸)                              â”‚
â”‚    â”œâ”€ ì¡°íšŒìˆ˜: 12íšŒ                                      â”‚
â”‚    â”œâ”€ ìµœê·¼ ìƒë‹´: 1ê±´                                    â”‚
â”‚    â””â”€ [ìƒì„¸ë³´ê¸°] [ìˆ˜ì •] [ë²„ì „ íˆìŠ¤í† ë¦¬]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

---

## 6. ë§ˆì´ê·¸ë ˆì´ì…˜ ê³„íš

### 6.1 ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜

```python
# alembic/versions/20251215_add_sub_category.py
"""add sub_category to manual_entries

Revision ID: 20251215_0001
Revises: 20251211_0003
Create Date: 2025-12-15
"""

from alembic import op
import sqlalchemy as sa


def upgrade():
    # 1. sub_category ì»¬ëŸ¼ ì¶”ê°€
    op.add_column(
        'manual_entries',
        sa.Column('sub_category', sa.String(100), nullable=True, comment='ì„¸ë¶€ ë¶„ë¥˜')
    )

    # 2. ì¸ë±ìŠ¤ ì¶”ê°€
    op.create_index(
        'idx_manual_entries_sub_category',
        'manual_entries',
        ['sub_category']
    )

    # 3. ë³µí•© ì¸ë±ìŠ¤ (ê·¸ë£¹ ì¡°íšŒ ìµœì í™”)
    op.create_index(
        'idx_manual_entries_group_subcategory',
        'manual_entries',
        ['business_type', 'error_code', 'sub_category', 'status']
    )

    # 4. ê¸°ì¡´ ë°ì´í„°ì— sub_category ìë™ í• ë‹¹
    # topicì—ì„œ ì¶”ì¶œí•˜ê±°ë‚˜ ê¸°ë³¸ê°’ ì„¤ì •
    op.execute("""
        UPDATE manual_entries
        SET sub_category = COALESCE(
            SPLIT_PART(topic, '-', 2),  -- "ì¹´ë“œ ìŠ¹ì¸ ì‹¤íŒ¨ - í•œë„ ì´ˆê³¼" â†’ "í•œë„ ì´ˆê³¼"
            'default'
        )
        WHERE sub_category IS NULL
    """)

    # 5. ManualVersion í…Œì´ë¸”ì—ë„ ì¶”ê°€
    op.add_column(
        'manual_versions',
        sa.Column('sub_category', sa.String(100), nullable=True)
    )

    # 6. UniqueConstraint ì¬ìƒì„±
    op.drop_constraint('uq_manual_version_group', 'manual_versions')
    op.create_unique_constraint(
        'uq_manual_version_group_subcategory',
        'manual_versions',
        ['business_type', 'error_code', 'sub_category', 'version']
    )


def downgrade():
    op.drop_constraint('uq_manual_version_group_subcategory', 'manual_versions')
    op.create_unique_constraint(
        'uq_manual_version_group',
        'manual_versions',
        ['business_type', 'error_code', 'version']
    )

    op.drop_column('manual_versions', 'sub_category')
    op.drop_index('idx_manual_entries_group_subcategory')
    op.drop_index('idx_manual_entries_sub_category')
    op.drop_column('manual_entries', 'sub_category')
```

### 6.2 ê¸°ì¡´ ë°ì´í„° ì •ë¦¬

```python
# scripts/migrate_existing_manuals.py
"""
ê¸°ì¡´ ë©”ë‰´ì–¼ì— sub_category ìë™ í• ë‹¹ ìŠ¤í¬ë¦½íŠ¸
"""

async def migrate_sub_categories():
    """
    1. topic ë¶„ì„ìœ¼ë¡œ sub_category ì¶”ì¶œ
    2. LLMìœ¼ë¡œ ìë™ ë¶„ë¥˜ (ì„ íƒì )
    3. ì¤‘ë³µ ì œê±°
    """

    # ëª¨ë“  ë©”ë‰´ì–¼ ì¡°íšŒ
    manuals = await manual_repo.find_all()

    for manual in manuals:
        # topicì—ì„œ sub_category ì¶”ì¶œ
        # ì˜ˆ: "ì¹´ë“œ ìŠ¹ì¸ ì‹¤íŒ¨ - í•œë„ ì´ˆê³¼" â†’ "í•œë„ ì´ˆê³¼"
        if ' - ' in manual.topic:
            sub_category = manual.topic.split(' - ')[-1].strip()
        else:
            # LLMìœ¼ë¡œ ë¶„ë¥˜ (ì„ íƒì )
            sub_category = await llm_client.categorize(manual.topic)

        manual.sub_category = sub_category
        await manual_repo.update(manual)
```

---

## 7. í…ŒìŠ¤íŠ¸ ê³„íš

### 7.1 ë‹¨ìœ„ í…ŒìŠ¤íŠ¸

```python
# tests/unit/test_multiple_manuals_per_group.py

async def test_different_topics_create_separate_manuals():
    """ê°™ì€ ê·¸ë£¹, ë‹¤ë¥¸ topic â†’ ë³„ë„ ë©”ë‰´ì–¼ ìƒì„±"""

    # v1 ìŠ¹ì¸
    v1 = await manual_service.create_draft_from_consultation(
        ConsultationCreate(topic="ì¹´ë“œ ìŠ¹ì¸ ì‹¤íŒ¨ - í•œë„ ì´ˆê³¼", ...)
    )
    await manual_service.approve_manual(v1.id)

    # v2 ìƒì„± (ë‹¤ë¥¸ topic)
    v2 = await manual_service.create_draft_from_consultation(
        ConsultationCreate(topic="ì¹´ë“œ ìŠ¹ì¸ ì‹¤íŒ¨ - í†µì‹  ì˜¤ë¥˜", ...)
    )

    # ê²€ì¦: v1ì€ ì—¬ì „íˆ APPROVED
    v1_after = await manual_repo.get_by_id(v1.id)
    assert v1_after.status == ManualStatus.APPROVED

    # v2 ìŠ¹ì¸
    await manual_service.approve_manual(v2.id)

    # ê²€ì¦: v1, v2 ëª¨ë‘ APPROVED
    v1_final = await manual_repo.get_by_id(v1.id)
    v2_final = await manual_repo.get_by_id(v2.id)

    assert v1_final.status == ManualStatus.APPROVED
    assert v2_final.status == ManualStatus.APPROVED
    assert v1_final.sub_category != v2_final.sub_category


async def test_similar_topics_deprecate_old_version():
    """ê°™ì€ sub_category â†’ ì´ì „ ë²„ì „ DEPRECATED"""

    v1 = await create_and_approve_manual(topic="í•œë„ ì´ˆê³¼ - ê¸°ë³¸")
    v2 = await create_and_approve_manual(topic="í•œë„ ì´ˆê³¼ - ê°œì„ ")

    # ê²€ì¦: v1ì€ DEPRECATED
    v1_after = await manual_repo.get_by_id(v1.id)
    assert v1_after.status == ManualStatus.DEPRECATED
```

### 7.2 í†µí•© í…ŒìŠ¤íŠ¸

```python
# tests/integration/test_manual_workflow_multiple.py

async def test_complete_workflow_with_multiple_causes():
    """ì‹¤ì œ ì›Œí¬í”Œë¡œìš°: 3ê°€ì§€ ì›ì¸ì˜ ë©”ë‰´ì–¼ ìƒì„±"""

    # 1. í•œë„ ì´ˆê³¼ ì¼€ì´ìŠ¤
    consultation1 = await create_consultation(
        inquiry="ì¹´ë“œ í•œë„ ë¶€ì¡±ìœ¼ë¡œ ê²°ì œ ì‹¤íŒ¨"
    )
    draft1 = await manual_service.create_draft_from_consultation(consultation1.id)
    await manual_service.approve_manual(draft1.id)

    # 2. í†µì‹  ì˜¤ë¥˜ ì¼€ì´ìŠ¤
    consultation2 = await create_consultation(
        inquiry="ë„¤íŠ¸ì›Œí¬ ì¥ì• ë¡œ ê²°ì œ ì‹¤íŒ¨"
    )
    draft2 = await manual_service.create_draft_from_consultation(consultation2.id)
    await manual_service.approve_manual(draft2.id)

    # 3. ì¹´ë“œ ì •ì§€ ì¼€ì´ìŠ¤
    consultation3 = await create_consultation(
        inquiry="ë„ë‚œ ì‹ ê³  ì¹´ë“œë¡œ ê²°ì œ ì‹œë„"
    )
    draft3 = await manual_service.create_draft_from_consultation(consultation3.id)
    await manual_service.approve_manual(draft3.id)

    # ê²€ì¦: 3ê°œ ëª¨ë‘ APPROVED
    manuals = await manual_repo.find_all_approved_by_group(
        business_type="ê²°ì œ",
        error_code="E001"
    )

    assert len(manuals) == 3
    assert all(m.status == ManualStatus.APPROVED for m in manuals)

    # ê²€ìƒ‰ ì‹œ ëª¨ë‘ ë°˜í™˜ë¨
    search_results = await manual_service.search_manuals(
        query="ì¹´ë“œ ê²°ì œ ì˜¤ë¥˜",
        business_type="ê²°ì œ"
    )

    assert len(search_results) >= 3
```

---

## 8. ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼

### 8.1 ë©”íŠ¸ë¦­

```python
# ì¶”ê°€í•  ë©”íŠ¸ë¦­
- manual_multiple_active_per_group: ê·¸ë£¹ë‹¹ í™œì„± ë©”ë‰´ì–¼ ìˆ˜
- manual_subcategory_distribution: sub_categoryë³„ ë¶„í¬
- review_task_separate_action_count: SEPARATE ì•¡ì…˜ ì‚¬ìš© ë¹ˆë„
- topic_similarity_low_count: topic ìœ ì‚¬ë„ ë‚®ì€ ì¼€ì´ìŠ¤ ìˆ˜
```

### 8.2 ì•Œë¦¼ ì¡°ê±´

```yaml
# ì•Œë¦¼ ì„¤ì •
alerts:
  - name: too_many_active_manuals_per_group
    condition: manual_multiple_active_per_group > 5
    severity: warning
    message: "ê·¸ë£¹ë‹¹ í™œì„± ë©”ë‰´ì–¼ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. ì—ëŸ¬ì½”ë“œ ì„¸ë¶„í™”ë¥¼ ê³ ë ¤í•˜ì„¸ìš”."

  - name: frequent_separate_actions
    condition: review_task_separate_action_count > 10/day
    severity: info
    message: "SEPARATE ì•¡ì…˜ì´ ë¹ˆë²ˆí•©ë‹ˆë‹¤. sub_category ìë™ ë¶„ë¥˜ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤."
```

---

## 9. ë¡¤ë°± ê³„íš

### Phase 1 ë¡¤ë°± (ë¦¬ë·° ì›Œí¬í”Œë¡œìš°)

- `comparison_metadata` í•„ë“œ ë¬´ì‹œ
- ê¸°ì¡´ ìŠ¹ì¸ ë¡œì§ìœ¼ë¡œ ë³µê·€
- ì˜í–¥: ì—†ìŒ (ë°ì´í„° ì†ì‹¤ ì—†ìŒ)

### Phase 2 ë¡¤ë°± (DB ìŠ¤í‚¤ë§ˆ ë³€ê²½)

```python
# alembic downgrade ì‹¤í–‰
alembic downgrade -1

# sub_category ë°ì´í„°ë¥¼ topicì— ë³‘í•© (ì„ íƒì )
UPDATE manual_entries
SET topic = CONCAT(topic, ' - ', sub_category)
WHERE sub_category IS NOT NULL;
```

---

## 10. ê´€ë ¨ íŒŒì¼

### ìˆ˜ì • í•„ìš” íŒŒì¼ (Phase 1)

- `app/schemas/task.py`: `comparison_metadata` ì¶”ê°€
- `app/services/manual_service.py`: `_create_review_task` ê°œì„ 
- `app/services/comparison_service.py`: topic ìœ ì‚¬ë„ ê³„ì‚° ì¶”ê°€
- `app/routers/tasks.py`: ìŠ¹ì¸ ìš”ì²­ì— `action` íŒŒë¼ë¯¸í„° ì¶”ê°€

### ìˆ˜ì • í•„ìš” íŒŒì¼ (Phase 2)

- `app/models/manual.py`: `sub_category` í•„ë“œ ì¶”ê°€
- `app/repositories/manual_rdb.py`: `find_all_approved_by_group` ë©”ì„œë“œ ì¶”ê°€
- `app/services/manual_service.py`: `_deprecate_previous_entries` ë¡œì§ ë³€ê²½
- `app/services/comparison_service.py`: `_get_target_manual` ë¡œì§ ë³€ê²½
- `alembic/versions/`: ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸

---

## 11. ì°¸ê³  ìë£Œ

- [AGENTS.md](../AGENTS.md): í”„ë¡œì íŠ¸ ì•„í‚¤í…ì²˜
- [app/models/manual.py](../app/models/manual.py): ManualStatus ì •ì˜
- [app/services/comparison_service.py](../app/services/comparison_service.py): ë¹„êµ ë¡œì§
- [app/services/manual_service.py](../app/services/manual_service.py): DEPRECATED ì²˜ë¦¬
- [docs/20251215_manual_versions_include_archived.md](./20251215_manual_versions_include_archived.md): ê´€ë ¨ ìš”êµ¬ì‚¬í•­

---

**ê²€í† ì**: Claude Code + ê°œë°œíŒ€
**ìµœì¢… ê²°ì • í•„ìš” ì‚¬í•­**:
1. Phase 1 ìš°ì„  êµ¬í˜„ í›„ Phase 2 ì§„í–‰í• ì§€ ê²°ì •
2. sub_category ìë™ ìƒì„± ë¡œì§ êµ¬í˜„ ë°©ì‹ (LLM vs ê·œì¹™ ê¸°ë°˜)
3. UI/UX ìƒì„¸ ë””ìì¸
